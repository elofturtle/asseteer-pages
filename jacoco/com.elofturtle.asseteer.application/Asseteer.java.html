<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sv"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Asseteer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Asseteer</a> &gt; <a href="index.source.html" class="el_package">com.elofturtle.asseteer.application</a> &gt; <span class="el_source">Asseteer.java</span></div><h1>Asseteer.java</h1><pre class="source lang-java linenums">package com.elofturtle.asseteer.application;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.InputMismatchException;
import java.util.List;
import java.util.Map;
import java.util.Scanner;

import java.io.BufferedWriter;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.OutputStreamWriter;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.io.FileOutputStream;
import com.elofturtle.asseteer.model.Asset;
import com.elofturtle.asseteer.model.Dependency;
import com.elofturtle.asseteer.model.Programvara;
import com.elofturtle.asseteer.model.SBOM;
import com.fasterxml.jackson.core.JsonProcessingException;
import com.elofturtle.asseteer.exception.PEBKAC;
import com.elofturtle.asseteer.exception.WeirdFileException;
import com.elofturtle.asseteer.io.XmlUtil;

/**
 * Huvudprogrammet
 */
public class Asseteer {
	/**
	 * Ett bibliotek med Assets
	 */
	private ArrayList&lt;Asset&gt; library;
	/**
	 * Tabell för omvänd sökning
	 */
	private Map&lt;String, List&lt;Dependency&gt;&gt; reverse_lookup;
	/**
	 * Här sparas programmets bibliotek mellan körningar
	 */
	private String globalStateFile;
	/**
	 * Skanner
	 */
	public Scanner scanner;
	
	/**
	 * Standardkonstruktor
	 * @param path sökväg till programkatalog
	 */
	public Asseteer(String path) {
		library = new ArrayList&lt;&gt;();
		globalStateFile = path;
		scanner = new Scanner(System.in);
		reverse_lookup = new HashMap&lt;&gt;();
	}
	
	/**
	 * Läs in programkatalogen, t.ex. vid uppstart.
	 * @throws WeirdFileException filundantag
	 */
	public void readState() throws WeirdFileException {
		Path filePath = Paths.get(globalStateFile);

        try {
            byte[] fileBytes = Files.readAllBytes(filePath);
            String fileContent = new String(fileBytes, StandardCharsets.UTF_8);
            library = XmlUtil.deserialize(fileContent);
        } catch (IOException e) {
            // Handle IOException
            System.err.println(&quot;An error occurred while reading the file: &quot; + e.getMessage());
            e.printStackTrace();
            throw new WeirdFileException(&quot;Unable to load application state&quot;, e);
        } catch (SecurityException e) {
            // Handle SecurityException
            System.err.println(&quot;A security error occurred: &quot; + e.getMessage());
            System.err.println(&quot;Program will exit!&quot;);
            e.printStackTrace();
            System.exit(1);
        } catch (Exception e) {
            // Handle any other unexpected exceptions
            System.err.println(&quot;An unexpected error occurred: &quot; + e.getMessage());
            System.err.println(&quot;Program will exit!&quot;);
            e.printStackTrace();
            System.exit(1);
        }
		
	}
	
	/**
	 * Spara programkatalogen, t.ex. när den har ändrats
	 * @throws WeirdFileException filundantag
	 */
	public void saveState() throws WeirdFileException {
		try {
			String s = XmlUtil.serialize(library);
			System.out.println(s);
			try (FileOutputStream fos = new FileOutputStream(globalStateFile);
					BufferedWriter writer = new BufferedWriter(new OutputStreamWriter(fos, &quot;UTF-8&quot;))) {
				writer.write(s);
			} catch (FileNotFoundException e) {
				e.printStackTrace();
				System.exit(1);
			} catch (IOException e) {
				e.printStackTrace();
				System.exit(1);
			}
		} catch (JsonProcessingException e) {
			e.printStackTrace();
			System.err.println(&quot;Malformed document&quot;);
			throw new WeirdFileException(&quot;Because of an issue, saving application state was not possible.&quot;, e);
		} 
	}

	/**
	 * Huvudmenyval
	 */
<span class="nc" id="L120">	enum MENU_STATE {</span>
<span class="nc" id="L121">		ADD_ASSET,</span>
<span class="nc" id="L122">		EDIT_ASSET,</span>
<span class="nc" id="L123">		REMOVE_ASSET,</span>
<span class="nc" id="L124">		LIST_ASSETS,</span>
<span class="nc" id="L125">		SEARCH_ASSET,</span>
<span class="nc" id="L126">		QUIT;</span>

		/**
		 *Strängrepresentation
		 *@return sträng sträng
		 */
		@Override
		public String toString() {
<span class="nc" id="L134">			return menuRepresentation(this);</span>
	}
}

	/**
	 * Huvudprogram
	 * @param args indata
	 * @throws PEBKAC användarfelsfel
	 */
	public static void main(String[] args) throws PEBKAC {
		Asseteer a = new Asseteer(System.getProperty(&quot;user.home&quot;) + &quot;/asseteer.xml&quot;);
		try {
			a.readState();
		} catch (WeirdFileException e) {
			e.printStackTrace();
			System.err.println(&quot;Corrupt file, start from scratch&quot;);
			a.library = new ArrayList&lt;&gt;();
		}
		
		while(true) {
		        MENU_STATE choice = menuOptionHelper(MENU_STATE.values(), &quot;### MAIN MENU ###&quot;, a.scanner); 
		        System.out.println(&quot;You selected: \&quot;&quot; + choice + &quot;\&quot;&quot;);
		        
		        switch (choice) {
			        case ADD_ASSET:
			        	a.MenuOptionAddAsset();
			        	break;
					case EDIT_ASSET:
						a.MenuOptionEditAsset();
						break;
					case LIST_ASSETS:
						a.MenuOptionListAssets();
						break;
					case REMOVE_ASSET:
						a.MenuOptionRemoveAsset();
						break;
					case SEARCH_ASSET:
						a.MenuOptionSearchAsset();
						break;
					case QUIT:
						System.out.println(&quot;Exiting...&quot;);
						System.exit(0);
						break;
					default:
						throw new PEBKAC(&quot;Inmatningsfel&quot;);
		        }  	
		}
    }

	private void MenuOptionListAssets() {
		for(var item : library) {
			System.out.println(item.toRepresentation());
		}
		
	}

	private void MenuOptionRemoveAsset() {
		System.out.println(&quot;Enter the name of the asset to remove:&quot;);
		String name = scanner.nextLine();
		Asset assetToRemove = null;
		for (Asset asset : library) {
			if (asset.getName().equals(name)) {
				assetToRemove = asset;
				break;
			}
		}
		if (assetToRemove != null) {
			library.remove(assetToRemove);
			System.out.println(&quot;Asset removed.&quot;);
			try {
				saveState();
			} catch (WeirdFileException e) {
				e.printStackTrace();
				System.err.println(&quot;Program will halt&quot;);
				System.exit(1);
			}
		} else {
			System.out.println(&quot;Asset not found.&quot;);
		}
	}


	private void MenuOptionSearchAsset() {
		System.out.println(&quot;Enter a part of the asset to search:&quot;);
		String s = scanner.nextLine();
		boolean foundAnything = false;
		for (Asset asset : library) {
			if (asset.getId().contains(s)) {
				foundAnything = true;
				System.out.println(asset.toRepresentation());
				continue;
			}
		}
		if(!foundAnything) {
			System.out.println(&quot;Asset not found.&quot;);
		}
	}

	private void MenuOptionEditAsset() {
		System.out.println(&quot;Enter the name of the asset to edit:&quot;);
		String name = scanner.nextLine();
		Asset assetToEdit = null;
		for (Asset asset : library) {
			if (asset.getName().equals(name)) {
				assetToEdit = asset;
				break;
			}
		}
		if (assetToEdit != null) {
			System.out.println(&quot;Found Asset\n&quot; + assetToEdit.toRepresentation());
			
			System.out.println(&quot;Enter new name (or press Enter to keep current name):&quot;);
			String newName = scanner.nextLine();
			if (!newName.isEmpty()) {
				assetToEdit.setName(newName);
			}

			if (assetToEdit instanceof SBOM) {
	            SBOM sbom = (SBOM) assetToEdit;

	            System.out.println(&quot;Enter new package name (or press Enter to keep current package name):&quot;);
	            String newPackageName = scanner.nextLine();

	            System.out.println(&quot;Enter new version (or press Enter to keep current version):&quot;);
	            String newVersion = scanner.nextLine();

	            if (!newPackageName.isEmpty() || !newName.isEmpty() || !newVersion.isEmpty()) {
	                String packageName = !newPackageName.isEmpty() ? newPackageName : sbom.getId().split(&quot;:&quot;)[1].split(&quot;/&quot;)[0];
	                String nameToUse = !newName.isEmpty() ? newName : sbom.getName();
	                String versionToUse = !newVersion.isEmpty() ? newVersion : sbom.getId().split(&quot;@&quot;)[1];

	                sbom.setId(&quot;pkg:&quot; + packageName + &quot;/&quot; + nameToUse + &quot;@&quot; + versionToUse);
	                
	                System.out.println(&quot;Is this a primary application? (y/n)&quot;);
	                String importantResponse = scanner.nextLine().trim().toLowerCase();
	                boolean important = importantResponse.equals(&quot;y&quot;) || importantResponse.equals(&quot;yes&quot;);
	                sbom.setImportant(important);
	            }
			}
	            
			else if (assetToEdit instanceof Programvara) {
				Programvara programvara = (Programvara) assetToEdit;
				System.out.println(&quot;Enter new owner (or press Enter to keep current owner):&quot;);
				String newOwner = scanner.nextLine();
				if (!newOwner.isEmpty()) {
					programvara.setÄgare(newOwner);
				}

				System.out.println(&quot;Enter new version (or press Enter to keep current version):&quot;);
				String programvaraNewVersion = scanner.nextLine();
				if (!programvaraNewVersion.isEmpty()) {
					programvara.setVersion(programvaraNewVersion);
				}

				System.out.println(&quot;Enter new supplier (or press Enter to keep current supplier):&quot;);
				String newSupplier = scanner.nextLine();
				if (!newSupplier.isEmpty()) {
					programvara.setLeverantör(newSupplier);
				}
			}

			System.out.println(&quot;Asset updated.&quot;);
			try {
				saveState();
			} catch (WeirdFileException e) {
				e.printStackTrace();
				System.exit(1);
			}
		} else {
			System.out.println(&quot;Asset not found.&quot;);
		}
	}

	private void MenuOptionAddAsset() throws PEBKAC {
<span class="nc" id="L308">		enum ASSET_TYPES{</span>
<span class="nc" id="L309">			PROGRAMVARA, </span>
<span class="nc" id="L310">			SBOM,</span>
<span class="nc" id="L311">			CANCEL</span>
		}
		
		System.out.println(&quot;Add Asset&quot;);

		var assetType = menuOptionHelper(ASSET_TYPES.values(), &quot;Add asset of which type?&quot;, scanner);
		switch(assetType) {
		case PROGRAMVARA:
			Programvara programvara = new Programvara();
			
			System.out.println(&quot;Name:&quot;);
			String programName = scanner.nextLine();
			programvara.setName(programName);
			
			System.out.println(&quot;Owner:&quot;);
			String programOwner = scanner.nextLine();
			programvara.setÄgare(programOwner);
			
			System.out.println(&quot;Version:&quot;);
			String programVersion = scanner.nextLine();
			programvara.setVersion(programVersion);
			
			System.out.println(&quot;Supplier:&quot;);
			String programSupplier = scanner.nextLine();
			programvara.setLeverantör(programSupplier);
			
			addDependencyMenuAction(programvara);
						
			library.add(programvara);
			try {
				saveState();
			} catch (WeirdFileException e) {
				e.printStackTrace();
				System.exit(1);
			}
			break;
		case SBOM:
			SBOM sbom = new SBOM();			
			System.out.println(&quot;Package:&quot;);
			String packageName = scanner.nextLine();
			
			System.out.println(&quot;Name:&quot;);
			
			String name = scanner.nextLine();
			
			System.out.println(&quot;Version:&quot;);
			String version = scanner.nextLine();
			
			System.out.println(&quot;Is this a primary application?&quot;);
			boolean important = scanner.nextBoolean();
			
			sbom.setName(name);
			sbom.setImportant(important);
			sbom.setId(&quot;pkg:&quot; + packageName + &quot;/&quot; + name + &quot;@&quot; + version);
			
			addDependencyMenuAction(sbom);
			
			library.add(sbom);
			try {
				saveState();
			} catch (WeirdFileException e) {
				e.printStackTrace();
				System.exit(1);
			}
			break;
			
		case CANCEL:
			return;
		}
	}

	/**
	 * Helper method
	 * @param asset asset to add
	 */
	private void addDependencyMenuAction(Asset asset) {
		System.out.println(&quot;Would you like to add a dependency? (y/n)&quot;);
		String addDependencyResponse = scanner.nextLine().trim().toLowerCase();
		boolean addDependency = addDependencyResponse.equals(&quot;y&quot;) || addDependencyResponse.equals(&quot;yes&quot;);
		
		while(addDependency) {
			System.out.println(&quot;Enter id of dependency:&quot;);
			String newdep = scanner.nextLine();
			System.out.println(&quot;New Dep: '&quot; + newdep + &quot;'&quot;);
			Dependency dependency = new Dependency(newdep);
			asset.addDependency(dependency);
			
			// A :- B --&gt; B :- A
			
			if(!reverse_lookup.containsKey(dependency.toString())) {
				reverse_lookup.put(dependency.toString(), new ArrayList&lt;Dependency&gt;());
			}
			reverse_lookup.get(dependency.toString()).add(new Dependency(asset));
			
			System.out.println(&quot;Would you like to add a dependency? (y/n)&quot;);
			addDependencyResponse = scanner.nextLine().trim().toLowerCase();
			addDependency = addDependencyResponse.equals(&quot;y&quot;) || addDependencyResponse.equals(&quot;yes&quot;);

		}
	}
	
	/**
	 * Helper method transforming enum name to a nice string that can be used in menus.
	 * @param e enum
	 * @return ADD_ASSET --&gt; Add asset
	 */
	private static String menuRepresentation(Enum&lt;?&gt; e) {
		return e.name().length() == 1? e.name().toUpperCase() : e.name().substring(0, 1).toUpperCase() + e.name().substring(1).toLowerCase().replaceAll(&quot;_&quot;, &quot; &quot;);
	}
	
	/**
	 * Standardkonstruktor
	 */
	public Asseteer() {
		library = new ArrayList&lt;Asset&gt;();
		reverse_lookup = new HashMap&lt;&gt;();
		scanner = new Scanner(System.in);
	}

    // GPT:s förslag E[] enumValues, hade helst velat skicka in typen istället, men orkar inte gräva just nu...
	// Vore intressant att diskutera alternativ vid tillfälle.
    /**
     * Use: {@code var foo = menuOptionHelper(MY_ENUM.values(), &quot;My Menu&quot;, scanner)}
     * &lt;p&gt;
     * This returns an actual enum value that can be used in a switch statement.
     * &lt;p&gt;
     * &lt;pre&gt;
     * My Menu
     * 1 foo
     * 2 bar
     * 3 baz
     * &lt;/pre&gt;
     * @param &lt;E&gt; specific enum type
     * @param enumValues enum values
     * @param menuName top display 
     * @param scanner e.g. System.in
     * @return the specific enum value chosen
     * @throws PEBKAC 
     */
    private static &lt;E extends Enum&lt;E&gt;&gt; E menuOptionHelper(E[] enumValues, String menuName, Scanner scanner) throws PEBKAC {
        boolean validInput = false;
        int choice = -1;

        while (!validInput) {
            System.out.println(menuName);
            for (int i = 0; i &lt; enumValues.length; i++) {
                System.out.println(&quot;(&quot; + (i + 1) + &quot;)\t&quot; + enumValues[i]);
            }

            try {
                System.out.print(&quot;Enter your choice (1 to &quot; + enumValues.length + &quot;): &quot;);
                choice = scanner.nextInt();
                scanner.nextLine();
                choice--; // Convert to zero-based index

                if (choice &gt;= 0 &amp;&amp; choice &lt; enumValues.length) {
                    validInput = true;
                    E selectedEnum = enumValues[choice];
                    return selectedEnum;
                } else {
                    System.out.println(&quot;Invalid choice. Please enter a number between 1 and &quot; + enumValues.length + &quot;.&quot;);
                    throw new PEBKAC(&quot;That is not a correct choice.&quot;);
                }
            } catch (InputMismatchException e) {
                if (scanner.hasNext()) {
                    if(scanner.nextLine().equalsIgnoreCase(&quot;q&quot;)) {
                    	System.out.println(&quot;User halted program&quot;);
                    	System.exit(0);
                    }
                    throw new PEBKAC(&quot;Invalid input. Please enter an integer.&quot;, e);
                }
            }
        }
		return null;
	    }
	}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>